<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [OpenIMSCore-Users] Registration failed with Ipsec enabled
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openimscore-users/2010-April/index.html" >
   <LINK REL="made" HREF="mailto:openimscore-users%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-Users%5D%20Registration%20failed%20with%20Ipsec%20enabled&In-Reply-To=%3C97083DFAC8827841B568A86D40354C4A03D70EDF%40ZMY16EXM66.ds.mot.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006187.html">
   <LINK REL="Next"  HREF="006189.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[OpenIMSCore-Users] Registration failed with Ipsec enabled</H1>
    <B>Sunil Suraj-a22975</B> 
    <A HREF="mailto:openimscore-users%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-Users%5D%20Registration%20failed%20with%20Ipsec%20enabled&In-Reply-To=%3C97083DFAC8827841B568A86D40354C4A03D70EDF%40ZMY16EXM66.ds.mot.com%3E"
       TITLE="[OpenIMSCore-Users] Registration failed with Ipsec enabled">surajsunil at motorola.com
       </A><BR>
    <I>Thu Apr  8 08:55:44 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="006187.html">[OpenIMSCore-Users] Registration failed with Ipsec enabled
</A></li>
        <LI>Next message: <A HREF="006189.html">[OpenIMSCore-Users] Registration failed with Ipsec enabled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6188">[ date ]</a>
              <a href="thread.html#6188">[ thread ]</a>
              <a href="subject.html#6188">[ subject ]</a>
              <a href="author.html#6188">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Naveen,

   Please find the ethereal logs for both server and client side.

In client side SAD and SPD as follows

10.232.15.41 10.232.14.119
        esp mode=transport spi=3030(0x00000bd6) reqid=0(0x00000000)
        E: 3des-cbc  63f03b9f e27b336b 568afa66 0de65f52 63f03b9f
e27b336b
        A: hmac-md5  9c282310 c117e3e1 b25efd77 b035d70d
        seq=0x00000000 replay=0 flags=0x00000000 state=mature
        created: Apr  8 17:38:53 2010   current: Apr  8 17:39:39 2010
        diff: 46(s)     hard: 0(s)      soft: 0(s)
        last:                           hard: 0(s)      soft: 0(s)
        current: 0(bytes)       hard: 0(bytes)  soft: 0(bytes)
        allocated: 0    hard: 0 soft: 0
        sadb_seq=3 pid=14309 refcnt=0
10.232.15.41 10.232.14.119
        esp mode=transport spi=3031(0x00000bd7) reqid=0(0x00000000)
        E: 3des-cbc  63f03b9f e27b336b 568afa66 0de65f52 63f03b9f
e27b336b
        A: hmac-md5  9c282310 c117e3e1 b25efd77 b035d70d
        seq=0x00000000 replay=0 flags=0x00000000 state=mature
        created: Apr  8 17:38:53 2010   current: Apr  8 17:39:39 2010
        diff: 46(s)     hard: 0(s)      soft: 0(s)
        last:                           hard: 0(s)      soft: 0(s)
        current: 0(bytes)       hard: 0(bytes)  soft: 0(bytes)
        allocated: 0    hard: 0 soft: 0
        sadb_seq=2 pid=14309 refcnt=0
10.232.14.119 10.232.15.41
        esp mode=transport spi=5006(0x0000138e) reqid=2(0x00000002)
        E: 3des-cbc  63f03b9f e27b336b 568afa66 0de65f52 63f03b9f
e27b336b
        A: hmac-md5  9c282310 c117e3e1 b25efd77 b035d70d
        seq=0x00000000 replay=0 flags=0x00000000 state=mature
        created: Apr  8 17:38:53 2010   current: Apr  8 17:39:39 2010
        diff: 46(s)     hard: 0(s)      soft: 0(s)
        last:                           hard: 0(s)      soft: 0(s)
        current: 0(bytes)       hard: 0(bytes)  soft: 0(bytes)
        allocated: 0    hard: 0 soft: 0
        sadb_seq=1 pid=14309 refcnt=0
10.232.14.119 10.232.15.41
        esp mode=transport spi=5007(0x0000138f) reqid=1(0x00000001)
        E: 3des-cbc  63f03b9f e27b336b 568afa66 0de65f52 63f03b9f
e27b336b
        A: hmac-md5  9c282310 c117e3e1 b25efd77 b035d70d
        seq=0x00000000 replay=0 flags=0x00000000 state=mature
        created: Apr  8 17:38:53 2010   current: Apr  8 17:39:39 2010
        diff: 46(s)     hard: 0(s)      soft: 0(s)
        last: Apr  8 17:38:53 2010      hard: 0(s)      soft: 0(s)
        current: 20832(bytes)   hard: 0(bytes)  soft: 0(bytes)
        allocated: 14   hard: 0 soft: 0
        sadb_seq=0 pid=14309 refcnt=0
[<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">root at pcwks182</A> ~]# setkey -DP
10.232.15.41[4060] 10.232.14.119[7072] any
        in prio def ipsec
        esp/transport//require
        created: Apr  8 17:38:53 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=224 seq=15 pid=14310
        refcnt=1
10.232.15.41[4060] 10.232.14.119[7071] any
        in prio def ipsec
        esp/transport//require
        created: Apr  8 17:38:53 2010  lastused: Apr  8 17:39:40 2010
        lifetime: 0(s) validtime: 0(s)
        spid=240 seq=14 pid=14310
        refcnt=2
10.232.14.119[7071] 10.232.15.41[4060] any
        out prio def ipsec
        esp/transport//unique:1
        created: Apr  8 17:38:53 2010  lastused: Apr  8 17:39:40 2010
        lifetime: 0(s) validtime: 0(s)
        spid=257 seq=13 pid=14310
        refcnt=2
10.232.14.119[7072] 10.232.15.41[4060] any
        out prio def ipsec
        esp/transport//unique:2
        created: Apr  8 17:38:53 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=265 seq=12 pid=14310
        refcnt=1
10.232.15.41[4060] 10.232.14.119[7072] any
        fwd prio def ipsec
        esp/transport//require
        created: Apr  8 17:38:53 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=234 seq=11 pid=14310
        refcnt=1
10.232.15.41[4060] 10.232.14.119[7071] any
        fwd prio def ipsec
        esp/transport//require
        created: Apr  8 17:38:53 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=250 seq=10 pid=14310
        refcnt=1
(per-socket policy)
        in none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=67 seq=9 pid=14310
        refcnt=1
(per-socket policy)
        in none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=51 seq=8 pid=14310
        refcnt=1
(per-socket policy)
        in none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=35 seq=7 pid=14310
        refcnt=1
(per-socket policy)
        in none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=19 seq=6 pid=14310
        refcnt=1
(per-socket policy)
        in none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=3 seq=5 pid=14310
        refcnt=1
(per-socket policy)
        out none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=76 seq=4 pid=14310
        refcnt=1
(per-socket policy)
        out none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=60 seq=3 pid=14310
        refcnt=1
(per-socket policy)
        out none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=44 seq=2 pid=14310
        refcnt=1
(per-socket policy)
        out none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=28 seq=1 pid=14310
        refcnt=1
(per-socket policy)
        out none
        created: Mar 30 22:10:44 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=12 seq=0 pid=14310
        refcnt=1

In server side SAD and SPD as follows

[<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">root at micslin14</A> ~]# setkey -D
10.232.14.119 10.232.15.41
        esp mode=transport spi=5003(0x0000138b) reqid=0(0x00000000)
        E: 3des-cbc  6207d061 a4ece1f7 7d3a73f9 c1362308 6207d061
a4ece1f7
        A: hmac-md5  c18f88d2 02b29555 cd9ba75d 20272697
        seq=0x00000000 replay=0 flags=0x00000000 state=mature
        created: Apr  8 12:03:31 2010   current: Apr  8 12:03:39 2010
        diff: 8(s)      hard: 0(s)      soft: 0(s)
        last: Apr  8 12:03:31 2010      hard: 0(s)      soft: 0(s)
        current: 7165(bytes)    hard: 0(bytes)  soft: 0(bytes)
        allocated: 5    hard: 0 soft: 0
        sadb_seq=0 pid=18683 refcnt=0
[<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">root at micslin14</A> ~]# setkey -DP
10.232.14.119[7071] 10.232.15.41[4060] tcp
        in prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=1376 seq=1 pid=18685
        refcnt=1
10.232.14.119[7071] 10.232.15.41[4060] udp
        in prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused: Apr  8 12:03:39 2010
        lifetime: 0(s) validtime: 0(s)
        spid=1392 seq=2 pid=18685
        refcnt=2
10.232.14.119[7071] 10.232.15.41[4060] tcp
        fwd prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=1386 seq=3 pid=18685
        refcnt=1
10.232.14.119[7071] 10.232.15.41[4060] udp
        fwd prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=1402 seq=0 pid=18685
        refcnt=1
[<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">root at micslin14</A> ~]# setkey -D
10.232.14.119 10.232.15.41
        esp mode=transport spi=5003(0x0000138b) reqid=0(0x00000000)
        E: 3des-cbc  6207d061 a4ece1f7 7d3a73f9 c1362308 6207d061
a4ece1f7
        A: hmac-md5  c18f88d2 02b29555 cd9ba75d 20272697
        seq=0x00000000 replay=0 flags=0x00000000 state=mature
        created: Apr  8 12:03:31 2010   current: Apr  8 12:04:13 2010
        diff: 42(s)     hard: 0(s)      soft: 0(s)
        last: Apr  8 12:03:31 2010      hard: 0(s)      soft: 0(s)
        current: 18629(bytes)   hard: 0(bytes)  soft: 0(bytes)
        allocated: 13   hard: 0 soft: 0
        sadb_seq=0 pid=18686 refcnt=0
[<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">root at micslin14</A> ~]# setkey -DP
10.232.14.119[7071] 10.232.15.41[4060] tcp
        in prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=1376 seq=1 pid=18687
        refcnt=1
10.232.14.119[7071] 10.232.15.41[4060] udp
        in prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused: Apr  8 12:04:19 2010
        lifetime: 0(s) validtime: 0(s)
        spid=1392 seq=2 pid=18687
        refcnt=2
10.232.14.119[7071] 10.232.15.41[4060] tcp
        fwd prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=1386 seq=3 pid=18687
        refcnt=1
10.232.14.119[7071] 10.232.15.41[4060] udp
        fwd prio def ipsec
        esp/transport//require
        created: Apr  8 12:03:31 2010  lastused:
        lifetime: 0(s) validtime: 0(s)
        spid=1402 seq=0 pid=18687
        refcnt=1

Regards,
Suraj

-----Original Message-----
From: Naveen BN [mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">naveen.bn at globaledgesoft.com</A>] 
Sent: Thursday, April 08, 2010 10:39 AM
To: Sunil Suraj-a22975
Cc: <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">openimscore-users at lists.berlios.de</A>; P Sudarshanakrishnan-A14377;
hanifa.mohammed
Subject: Re: [OpenIMSCore-Users] Registration failed with Ipsec enabled

Hi Sunil,
Is the second secure register message reaching the server application(
pcscf ).
Please share the SADB and SPD contents at the server and client.

Regards
Naveen

Sunil Suraj-a22975 wrote:
&gt;<i> Hi All,
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i>        Following behaviour is observed while testing the Registration 
</I>&gt;<i> with IPsec Secuirity agreement
</I>&gt;<i>  
</I>&gt;<i>        First REGISTER message sent with security client header
</I>&gt;<i>  
</I>&gt;<i>       Security-Client: 
</I>&gt;<i>
</I>ipsec-3gpp;alg=hmac-md5-96;prot=esp;ealg=des-ede3-cbc;spi-c=3030;spi-s=3
031;port-c=7071;port-s=7072
&gt;<i>       Server challenges the request with 401 with Security server 
</I>&gt;<i> header
</I>&gt;<i>  
</I>&gt;<i>       Security-Server: ipsec-3gpp; ealg=des-ede3-cbc; alg=hmac-md5-96;
</I>
&gt;<i> spi-c=5000; spi-s=5001; port-c=4060; port-s=4060; prot=esp; mod=trans;
</I>&gt;<i> q=0.1
</I>&gt;<i>  
</I>&gt;<i>       Our client sends reRegister with Security verify header with 
</I>&gt;<i> local port 7071 to remote port 4060. Message is as follows
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> REGISTER sip:open-ims.test SIP/2.0
</I>&gt;<i> To: Satya &lt;sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">kaushik at open-ims.test</A>&gt;
</I>&gt;<i> From: Satya
</I>&gt;<i> &lt;sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">kaushik at open-ims.test</A>&gt;;tag=18-161236328-0-d7d614b7-00000001
</I>&gt;<i> Route: &lt;sip:10.232.15.41:4060;lr&gt;
</I>&gt;<i> Call-ID: <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">d7d614b7099d64081 at 3621131447</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">d7d614b7099d64081 at 3621131447</A>&gt;
</I>&gt;<i> Expires: 3600
</I>&gt;<i> CSeq: 2 REGISTER
</I>&gt;<i> Via: SIP/2.0/UDP 10.232.14.119:7072;rport;branch=z9hG4bK7042b057ef1f66
</I>&gt;<i> Supported: timer,timer,path,sec-agree
</I>&gt;<i> Allow: 
</I>&gt;<i> ACK,BYE,CANCEL,INVITE,OPTIONS,REGISTER,INFO,PRACK,SUBSCRIBE,NOTIFY,UPD
</I>&gt;<i> ATE,MESSAGE,REFER,PUBLISH
</I>&gt;<i> Accept-Encoding: identity
</I>&gt;<i> Accept: 
</I>&gt;<i> application/sdp,multipart/mixed,application/reginfo+xml,message/sipfra
</I>&gt;<i> g,application/simple-message-summary,application/dialog-info+xml,appli
</I>&gt;<i> cation/server-call-feature-status+xml,application/xml
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Max-Forwards: 70
</I>&gt;<i> P-Access-Network-Info: LAN
</I>&gt;<i> User-Agent: Symphony UA
</I>&gt;<i> History-Info: sip:open-ims.test;index=1
</I>&gt;<i> Require: sec-agree
</I>&gt;<i> Proxy-Require: sec-agree
</I>&gt;<i> Authorization: Digest
</I>&gt;<i> algorithm=AKAv1-MD5,cnonce=&quot;d7d61596&quot;,nc=00000001,nonce=&quot;kSOd4x/87l2Af
</I>&gt;<i> Lxkpnyfg4jcucuJHAAASZEB5wJsBMQ=&quot;,qop=auth,realm=&quot;open-ims.test&quot;,respon
</I>&gt;<i> se=&quot;93b8abc08d7e4e403e231616bcfa8794&quot;,uri=&quot;sip:open-ims.test&quot;,username
</I>&gt;<i> =&quot;<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">kaushik at open-ims.test</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">kaushik at open-ims.test</A>&gt;&quot;
</I>&gt;<i> Security-Client: 
</I>&gt;<i> ipsec-3gpp;alg=hmac-md5-96;prot=esp;ealg=des-ede3-cbc;spi-c=3030;spi-s
</I>&gt;<i> =3031;port-c=7071;port-s=7072
</I>&gt;<i> Security-Verify: 
</I>&gt;<i> ipsec-3gpp;q=0.1;alg=hmac-md5-96;prot=esp;ealg=des-ede3-cbc;spi-c=5000
</I>&gt;<i> ;spi-s=5001;port-c=4060;port-s=4060
</I>&gt;<i> Contact: sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">kaushik at 10.232.14.119</A>:7072
</I>&gt;<i>  
</I>&gt;<i>      Server sends 494 Security Agreement Required.
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i>   Please anyone let me know the reason for this.
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> Attached ethereal logs from OpenIms side.
</I>&gt;<i>  
</I>&gt;<i> Regards,
</I>&gt;<i> Suraj
</I>&gt;<i>
</I>&gt;<i>    
</I>&gt;<i> ----------------------------------------------------------------------
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> OpenIMSCore-Users mailing list
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">OpenIMSCore-Users at lists.berlios.de</A>
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">https://lists.berlios.de/mailman/listinfo/openimscore-users</A>
</I>&gt;<i>   
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: server.pcap
Type: application/octet-stream
Size: 201880 bytes
Desc: server.pcap
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/openimscore-users/attachments/20100408/e1b94596/attachment.obj">https://lists.berlios.de/pipermail/openimscore-users/attachments/20100408/e1b94596/attachment.obj</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: client.pcap
Type: application/octet-stream
Size: 45476 bytes
Desc: client.pcap
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/openimscore-users/attachments/20100408/e1b94596/attachment-0001.obj">https://lists.berlios.de/pipermail/openimscore-users/attachments/20100408/e1b94596/attachment-0001.obj</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006187.html">[OpenIMSCore-Users] Registration failed with Ipsec enabled
</A></li>
	<LI>Next message: <A HREF="006189.html">[OpenIMSCore-Users] Registration failed with Ipsec enabled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6188">[ date ]</a>
              <a href="thread.html#6188">[ thread ]</a>
              <a href="subject.html#6188">[ subject ]</a>
              <a href="author.html#6188">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openimscore-users">More information about the OpenIMSCore-Users
mailing list</a><br>
</body></html>
