<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openimscore-users/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:openimscore-users%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-Users%5D%20P-CSCF%20got%20segfault%20while%20Forwarding%20INVITE%0A%20received%20in%20TLS.&In-Reply-To=%3C4A9E0149.2000604%40globaledgesoft.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005721.html">
   <LINK REL="Next"  HREF="005793.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.</H1>
    <B>prashanth.me</B> 
    <A HREF="mailto:openimscore-users%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-Users%5D%20P-CSCF%20got%20segfault%20while%20Forwarding%20INVITE%0A%20received%20in%20TLS.&In-Reply-To=%3C4A9E0149.2000604%40globaledgesoft.com%3E"
       TITLE="[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.">prashanth.me at globaledgesoft.com
       </A><BR>
    <I>Wed Sep  2 07:23:21 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005721.html">[OpenIMSCore-Users] error when running sipP
</A></li>
        <LI>Next message: <A HREF="005793.html">[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE	received in TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5722">[ date ]</a>
              <a href="thread.html#5722">[ thread ]</a>
              <a href="subject.html#5722">[ subject ]</a>
              <a href="author.html#5722">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Gemi Tsai,
    Thanks for the patch.

    Even after applying the patch, P-CSCF crashes in same  function 
get_send_socket() of forward.c @ line 172
     if (msg-&gt;force_send_socket-&gt;socket==-1)    where 
'msg-&gt;force_send_socket'  will be NULL
    (code dump trace provided bellow for reference).
   
This time we are trying to subscribe to the reg event, we received 200 
OK for subscribe.
but before receiving NOTIFY message  P-CSCF crashes. I have attached the 
loopback capture for reference.

By analyzing loop back capture, It looks that when S-CSCF send the 
NOTIFY to P-CSCF.
P-CSCF is unable to forward the Notify to registered user (Bob).
TLS session is closed by closing Underlying  TCP connection.

When check is added before dereferencing NULL pointer 
'msg-&gt;force_send_socket' to avoid the crash,
NOTIFY was forwarded in UDP, to TLS session port which is used while 
establishing TLS session.

please help us to resolve this problem.

Regards,
Prashanth M E

/********************************* Core Dump 
************************************/
Core was generated by `/opt/OpenIMSCore/ser_ims/ser -f 
/opt/OpenIMSCore/pcscf.cfg -D -D'.
Program terminated with signal 11, Segmentation fault.
#0  get_send_socket (msg=0x81b83c8, to=0xb61f4cf0, proto=1) at forward.c:172
172                             if (msg-&gt;force_send_socket-&gt;socket==-1)
(gdb) p msg-&gt;force_send_socket
$1 = (struct socket_info *) 0x0
(gdb) bt
#0  get_send_socket (msg=0x81b83c8, to=0xb61f4cf0, proto=1) at forward.c:172
#1  0x00138c9c in add_uac (t=0xb61f4be8, request=0x81b83c8, 
uri=0x81b83e4, next_hop=0x81b8518,
    proxy=0x0, proto=0) at ut.h:308
#2  0x0013ad2e in t_forward_nonack (t=0xb61f4be8, p_msg=0x81b83c8, 
proxy=0x0, proto=0)
    at t_fwd.c:762
#3  0x001354c2 in t_relay_to (p_msg=0x81b83c8, proxy=0x0, proto=0, 
replicate=0) at t_funcs.c:285
#4  0x00143f60 in w_t_relay (p_msg=0x81b83c8, _foo=0x0, _bar=0x0) at 
tm.c:1118
#5  0x08051f93 in do_action (a=0x81b2ce4, msg=0x81b83c8) at action.c:681
#6  0x080549ab in run_actions (a=0x81b2ce4, msg=0x81b83c8) at action.c:920
#7  0x0809f4e6 in eval_expr (e=0x81b2d50, msg=0x81b83c8) at route.c:1050
#8  0x0809f2cf in eval_expr (e=0x81b2da0, msg=0x81b83c8) at route.c:1170
#9  0x08051d4f in do_action (a=0x81b30d8, msg=0x81b83c8) at action.c:652
#10 0x080549ab in run_actions (a=0x81b18c8, msg=0x81b83c8) at action.c:920
#11 0x08051c4a in do_action (a=0x8199210, msg=0x81b83c8) at action.c:439
#12 0x080549ab in run_actions (a=0x8199210, msg=0x81b83c8) at action.c:920
#13 0x08054370 in do_action (a=0x8199398, msg=0x81b83c8) at action.c:672
#14 0x080549ab in run_actions (a=0x8199398, msg=0x81b83c8) at action.c:920
#15 0x08054370 in do_action (a=0x8199470, msg=0x81b83c8) at action.c:672
#16 0x080549ab in run_actions (a=0x8198d90, msg=0x81b83c8) at action.c:920
#17 0x08054370 in do_action (a=0x819c368, msg=0x81b83c8) at action.c:672
#18 0x080549ab in run_actions (a=0x8197954, msg=0x81b83c8) at action.c:920
#19 0x08095832 in receive_msg (
    buf=0x814c7a0 &quot;NOTIFY sips:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">bob at 172.16.8.41</A>:2947 SIP/2.0\r\nVia: 
SIP/2.0/UDP 172.16.8.90:6060;bran---Type &lt;return&gt; to continue, or q 
&lt;return&gt; to quit---
ch=z9hG4bKcfa7.ec6c7716.0\r\nTo: 
&lt;sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">bob at open-ims.test</A>&gt;;tag=11478\r\nFrom: 
&lt;sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">bob at open-ims.test</A>&gt;;tag=f37804401fa7b6a3df3f&quot;..., len=1944, 
rcv_info=0xbff36b38) at receive.c:171
#20 0x080d363d in udp_rcv_loop () at udp_server.c:496
#21 0x0807e311 in main_loop () at main.c:1025
#22 0x0807f7d1 in main (argc=Cannot access memory at address 0x1
) at main.c:1614
(gdb)

Gemi Tsai &#34081;&#22283;&#27888; wrote:
&gt;<i> Hi Prashant,
</I>&gt;<i>
</I>&gt;<i> Please try the following patch:
</I>&gt;<i> I guess it is the TLS crash issue.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Gemi
</I>&gt;<i>
</I>&gt;<i> Index: modules/tls/tls_select.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- modules/tls/tls_select.c    (revision 711)
</I>&gt;<i> +++ modules/tls/tls_select.c    (working copy)
</I>&gt;<i> @@ -99,7 +99,9 @@
</I>&gt;<i>                 tcpconn_put(c);
</I>&gt;<i>                 return 0;
</I>&gt;<i>         }
</I>&gt;<i> -       ses_hash = SSL_SESSION_hash(ssl_ses);
</I>&gt;<i> +       //gemi: use the session pointer address replace session id
</I>&gt;<i> +       //ses_hash = SSL_SESSION_hash(ssl_ses);
</I>&gt;<i> +       ses_hash = (unsigned long) ssl_ses;
</I>&gt;<i>
</I>&gt;<i>         tcpconn_put(c);
</I>&gt;<i>         return ses_hash;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2009/8/3 Franz Edler &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">franz-edler at aon.at</A>&gt;:
</I>&gt;<i>   
</I>&gt;&gt;<i> Hi Prashant,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     
</I>&gt;&gt;&gt;<i>  Please can any one knows what is the meaning of  Debug statements
</I>&gt;&gt;&gt;<i>  4(12942) get_send_socket: force_send_socket of different proto (1)!!
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;<i> I think that means that on transitioning the P-CSCF the transport protocol
</I>&gt;&gt;<i> has to change from UDP to TCP/TLS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FRanz
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> OpenIMSCore-Users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">OpenIMSCore-Users at lists.berlios.de</A>
</I>&gt;&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">https://lists.berlios.de/mailman/listinfo/openimscore-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     
</I>&gt;<i>
</I>&gt;<i>   
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/openimscore-users/attachments/20090902/d451e013/attachment.html">https://lists.berlios.de/pipermail/openimscore-users/attachments/20090902/d451e013/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: tls_capture.zip
Type: application/zip
Size: 3048 bytes
Desc: not available
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/openimscore-users/attachments/20090902/d451e013/attachment.zip">https://lists.berlios.de/pipermail/openimscore-users/attachments/20090902/d451e013/attachment.zip</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005721.html">[OpenIMSCore-Users] error when running sipP
</A></li>
	<LI>Next message: <A HREF="005793.html">[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE	received in TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5722">[ date ]</a>
              <a href="thread.html#5722">[ thread ]</a>
              <a href="subject.html#5722">[ subject ]</a>
              <a href="author.html#5722">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openimscore-users">More information about the OpenIMSCore-Users
mailing list</a><br>
</body></html>
