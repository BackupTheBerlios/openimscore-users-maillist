<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE	received in TLS.
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openimscore-users/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:openimscore-users%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-Users%5D%20P-CSCF%20got%20segfault%20while%20Forwarding%20INVITE%0A%09received%20in%20TLS.&In-Reply-To=%3Cbe1da43f0909290104p7e0aaff5j551a490c111b864b%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005722.html">
   <LINK REL="Next"  HREF="005795.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE	received in TLS.</H1>
    <B>Laurent Etiemble</B> 
    <A HREF="mailto:openimscore-users%40lists.berlios.de?Subject=Re%3A%20%5BOpenIMSCore-Users%5D%20P-CSCF%20got%20segfault%20while%20Forwarding%20INVITE%0A%09received%20in%20TLS.&In-Reply-To=%3Cbe1da43f0909290104p7e0aaff5j551a490c111b864b%40mail.gmail.com%3E"
       TITLE="[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE	received in TLS.">laurent.etiemble at inexbee.com
       </A><BR>
    <I>Tue Sep 29 10:04:13 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="005722.html">[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.
</A></li>
        <LI>Next message: <A HREF="005795.html">[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5793">[ date ]</a>
              <a href="thread.html#5793">[ thread ]</a>
              <a href="subject.html#5793">[ subject ]</a>
              <a href="author.html#5793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

The crash is caused by the NAT helper, as it tries to use a closed
connection. Disable the NAT helper in your pcscf.cfg.

Regards, Laurent Etiemble.

2009/9/2 prashanth.me &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">prashanth.me at globaledgesoft.com</A>&gt;:
&gt;<i> Hi Gemi Tsai,
</I>&gt;<i> &#160;&#160;&#160; Thanks for the patch.
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; Even after applying the patch, P-CSCF crashes in same&#160; function
</I>&gt;<i> get_send_socket() of forward.c @ line 172
</I>&gt;<i> &#160;&#160;&#160;&#160; if (msg-&gt;force_send_socket-&gt;socket==-1)&#160;&#160;&#160; where
</I>&gt;<i> 'msg-&gt;force_send_socket'&#160; will be NULL
</I>&gt;<i> &#160;&#160;&#160; (code dump trace provided bellow for reference).
</I>&gt;<i>
</I>&gt;<i> This time we are trying to subscribe to the reg event, we received 200 OK
</I>&gt;<i> for subscribe.
</I>&gt;<i> but before receiving NOTIFY message&#160; P-CSCF crashes. I have attached the
</I>&gt;<i> loopback capture for reference.
</I>&gt;<i>
</I>&gt;<i> By analyzing loop back capture, It looks that when S-CSCF send the NOTIFY to
</I>&gt;<i> P-CSCF.
</I>&gt;<i> P-CSCF is unable to forward the Notify to registered user (Bob).
</I>&gt;<i> TLS session is closed by closing Underlying&#160; TCP connection.
</I>&gt;<i>
</I>&gt;<i> When check is added before dereferencing NULL pointer
</I>&gt;<i> 'msg-&gt;force_send_socket' to avoid the crash,
</I>&gt;<i> NOTIFY was forwarded in UDP, to TLS session port which is used while
</I>&gt;<i> establishing TLS session.
</I>&gt;<i>
</I>&gt;<i> please help us to resolve this problem.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Prashanth M E
</I>&gt;<i>
</I>&gt;<i> /********************************* Core Dump
</I>&gt;<i> ************************************/
</I>&gt;<i> Core was generated by `/opt/OpenIMSCore/ser_ims/ser -f
</I>&gt;<i> /opt/OpenIMSCore/pcscf.cfg -D -D'.
</I>&gt;<i> Program terminated with signal 11, Segmentation fault.
</I>&gt;<i> #0&#160; get_send_socket (msg=0x81b83c8, to=0xb61f4cf0, proto=1) at forward.c:172
</I>&gt;<i> 172&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (msg-&gt;force_send_socket-&gt;socket==-1)
</I>&gt;<i> (gdb) p msg-&gt;force_send_socket
</I>&gt;<i> $1 = (struct socket_info *) 0x0
</I>&gt;<i> (gdb) bt
</I>&gt;<i> #0&#160; get_send_socket (msg=0x81b83c8, to=0xb61f4cf0, proto=1) at forward.c:172
</I>&gt;<i> #1&#160; 0x00138c9c in add_uac (t=0xb61f4be8, request=0x81b83c8, uri=0x81b83e4,
</I>&gt;<i> next_hop=0x81b8518,
</I>&gt;<i> &#160;&#160;&#160; proxy=0x0, proto=0) at ut.h:308
</I>&gt;<i> #2&#160; 0x0013ad2e in t_forward_nonack (t=0xb61f4be8, p_msg=0x81b83c8,
</I>&gt;<i> proxy=0x0, proto=0)
</I>&gt;<i> &#160;&#160;&#160; at t_fwd.c:762
</I>&gt;<i> #3&#160; 0x001354c2 in t_relay_to (p_msg=0x81b83c8, proxy=0x0, proto=0,
</I>&gt;<i> replicate=0) at t_funcs.c:285
</I>&gt;<i> #4&#160; 0x00143f60 in w_t_relay (p_msg=0x81b83c8, _foo=0x0, _bar=0x0) at
</I>&gt;<i> tm.c:1118
</I>&gt;<i> #5&#160; 0x08051f93 in do_action (a=0x81b2ce4, msg=0x81b83c8) at action.c:681
</I>&gt;<i> #6&#160; 0x080549ab in run_actions (a=0x81b2ce4, msg=0x81b83c8) at action.c:920
</I>&gt;<i> #7&#160; 0x0809f4e6 in eval_expr (e=0x81b2d50, msg=0x81b83c8) at route.c:1050
</I>&gt;<i> #8&#160; 0x0809f2cf in eval_expr (e=0x81b2da0, msg=0x81b83c8) at route.c:1170
</I>&gt;<i> #9&#160; 0x08051d4f in do_action (a=0x81b30d8, msg=0x81b83c8) at action.c:652
</I>&gt;<i> #10 0x080549ab in run_actions (a=0x81b18c8, msg=0x81b83c8) at action.c:920
</I>&gt;<i> #11 0x08051c4a in do_action (a=0x8199210, msg=0x81b83c8) at action.c:439
</I>&gt;<i> #12 0x080549ab in run_actions (a=0x8199210, msg=0x81b83c8) at action.c:920
</I>&gt;<i> #13 0x08054370 in do_action (a=0x8199398, msg=0x81b83c8) at action.c:672
</I>&gt;<i> #14 0x080549ab in run_actions (a=0x8199398, msg=0x81b83c8) at action.c:920
</I>&gt;<i> #15 0x08054370 in do_action (a=0x8199470, msg=0x81b83c8) at action.c:672
</I>&gt;<i> #16 0x080549ab in run_actions (a=0x8198d90, msg=0x81b83c8) at action.c:920
</I>&gt;<i> #17 0x08054370 in do_action (a=0x819c368, msg=0x81b83c8) at action.c:672
</I>&gt;<i> #18 0x080549ab in run_actions (a=0x8197954, msg=0x81b83c8) at action.c:920
</I>&gt;<i> #19 0x08095832 in receive_msg (
</I>&gt;<i> &#160;&#160;&#160; buf=0x814c7a0 &quot;NOTIFY sips:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">bob at 172.16.8.41</A>:2947 SIP/2.0\r\nVia:
</I>&gt;<i> SIP/2.0/UDP 172.16.8.90:6060;bran---Type &lt;return&gt; to continue, or q &lt;return&gt;
</I>&gt;<i> to quit---
</I>&gt;<i> ch=z9hG4bKcfa7.ec6c7716.0\r\nTo: &lt;sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">bob at open-ims.test</A>&gt;;tag=11478\r\nFrom:
</I>&gt;<i> &lt;sip:<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">bob at open-ims.test</A>&gt;;tag=f37804401fa7b6a3df3f&quot;..., len=1944,
</I>&gt;<i> rcv_info=0xbff36b38) at receive.c:171
</I>&gt;<i> #20 0x080d363d in udp_rcv_loop () at udp_server.c:496
</I>&gt;<i> #21 0x0807e311 in main_loop () at main.c:1025
</I>&gt;<i> #22 0x0807f7d1 in main (argc=Cannot access memory at address 0x1
</I>&gt;<i> ) at main.c:1614
</I>&gt;<i> (gdb)
</I>&gt;<i>
</I>&gt;<i> Gemi Tsai &#34081;&#22283;&#27888; wrote:
</I>&gt;<i>
</I>&gt;<i> Hi Prashant,
</I>&gt;<i>
</I>&gt;<i> Please try the following patch:
</I>&gt;<i> I guess it is the TLS crash issue.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Gemi
</I>&gt;<i>
</I>&gt;<i> Index: modules/tls/tls_select.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- modules/tls/tls_select.c    (revision 711)
</I>&gt;<i> +++ modules/tls/tls_select.c    (working copy)
</I>&gt;<i> @@ -99,7 +99,9 @@
</I>&gt;<i>                 tcpconn_put(c);
</I>&gt;<i>                 return 0;
</I>&gt;<i>         }
</I>&gt;<i> -       ses_hash = SSL_SESSION_hash(ssl_ses);
</I>&gt;<i> +       //gemi: use the session pointer address replace session id
</I>&gt;<i> +       //ses_hash = SSL_SESSION_hash(ssl_ses);
</I>&gt;<i> +       ses_hash = (unsigned long) ssl_ses;
</I>&gt;<i>
</I>&gt;<i>         tcpconn_put(c);
</I>&gt;<i>         return ses_hash;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2009/8/3 Franz Edler &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">franz-edler at aon.at</A>&gt;:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi Prashant,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160;Please can any one knows what is the meaning of &#160;Debug statements
</I>&gt;<i> &#160;4(12942) get_send_socket: force_send_socket of different proto (1)!!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I think that means that on transitioning the P-CSCF the transport protocol
</I>&gt;<i> has to change from UDP to TCP/TLS.
</I>&gt;<i>
</I>&gt;<i> FRanz
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> OpenIMSCore-Users mailing list
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">OpenIMSCore-Users at lists.berlios.de</A>
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">https://lists.berlios.de/mailman/listinfo/openimscore-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> OpenIMSCore-Users mailing list
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">OpenIMSCore-Users at lists.berlios.de</A>
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/openimscore-users">https://lists.berlios.de/mailman/listinfo/openimscore-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005722.html">[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.
</A></li>
	<LI>Next message: <A HREF="005795.html">[OpenIMSCore-Users] P-CSCF got segfault while Forwarding INVITE received in TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5793">[ date ]</a>
              <a href="thread.html#5793">[ thread ]</a>
              <a href="subject.html#5793">[ subject ]</a>
              <a href="author.html#5793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openimscore-users">More information about the OpenIMSCore-Users
mailing list</a><br>
</body></html>
